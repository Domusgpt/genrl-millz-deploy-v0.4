document.addEventListener('DOMContentLoaded',()=>{fetchMagazineData()});async function fetchMagazineData(){const e="/api/current-data";try{const t=await fetch(e,{cache:"no-store"});if(!t.ok){const e=await t.text().catch(()=>`Status: ${t.status}`);throw new Error(`HTTP error! ${e}`)}const n=t.headers.get("content-type");if(!n||!n.includes("application/json"))throw new Error(`Expected JSON, but received ${n}`);const o=await t.json();if(!o||"object"!=typeof o)throw new Error("Invalid data structure received from API.");renderMagazine(o)}catch(e){console.error("Failed to fetch or parse magazine data:",e),displayLoadError(e.message)}}function renderMagazine(e){console.log(`Rendering Cycle: ${e.cycleNumber}`),setTextContent('#cycle-number',e.cycleNumber),setTextContent('#transmission-date',e.transmissionDate),setTextContent('#year',(new Date).getFullYear()),setTextContent('#footer-mantra',e.footerMantra);const t=document.querySelector('.content-grid');if(!t)return void console.error("Fatal Error: Main content grid container (.content-grid) not found.");t.innerHTML='',document.querySelectorAll('.content-module.has-visual-focus').forEach(e=>e.classList.remove('has-visual-focus'));const n=e.layoutConfiguration||{};applyLayoutTemplate(n.templateName);let o=getOrderedModules(e.mainContent,n.moduleOrder);if(o&&0!==o.length){const t=n.featuredVisualTargetId;o.forEach((n,o)=>{if(!n||"object"!=typeof n||!n.id||!n.type)return void console.warn(`Skipping invalid content item at index ${o}:`,n);const r=createContentModuleElement(n,o);r&&(n.id===t&&r.classList.add('has-visual-focus'),mainGrid.appendChild(r))})}else t.innerHTML='<p class="error-message">// No Valid Content Blocks Received //</p>',console.warn("No modules to render in mainContent.");applyStyleOverrides(e.styleOverrides),document.documentElement.classList.remove('no-js'),document.documentElement.classList.add('js-ready')}function applyLayoutTemplate(e){const t="standard-grid",n=e||t;document.body.className="",document.body.classList.add(n),console.log(`Applied layout template class: ${n}`)}function getOrderedModules(e=[],t){if(!Array.isArray(e))return[];if(!t||!Array.isArray(t)||0===t.length)return e;try{const n=new Map(e.map(e=>e?[e.id,e]:[null,null]).filter(e=>e[0])),o=t.map(e=>n.get(e)).filter(e=>void 0!==e),r=new Set(t),s=e.filter(e=>e&&!r.has(e.id));if(s.length>0)console.warn(`Module order array was incomplete or contained invalid IDs. Appended ${s.length} missing items.`);const l=[...o,...s];return l.length>0?(console.log("Applied custom module order."),l):(console.warn("Custom module order resulted in empty list. Using default."),e)}catch(n){return console.error("Error applying module order:",n),e}}function createContentModuleElement(e,t){const n=document.createElement('section');n.id=e.id;let o=['content-module',`${e.type}-module`,'animate-entrance'],r=!1,s=!1,l='',a='';switch(e.type){case"directive":l=e.title||"// DIRECTIVE //",a=e.content||"<p>[Directive Content Missing]</p>",r=!0,o.push('holographic-panel');break;case"article":l=e.title||"// ARCHIVE ENTRY //",a=e.content||"<p>[Article Content Missing]</p>";break;case"letter":l=`// FROM: ${e.sender||"UNKNOWN"} //`,a=e.content||"<p>[Letter Content Missing]</p>";break;case"cipher":l=e.title||"// ENCRYPTED //",a=`<div class="cipher-text">${e.content||"[Cipher Text Missing]"}</div>`,e.decryptionHint&&(a+=`<p class="cipher-hint">Hint: ${e.decryptionHint}</p>`),r=!0,s=!0,o.push('holographic-panel','small-module');break;default:console.warn(`Rendering unknown content type: ${e.type} for ID: ${e.id}`),l=`// UNKNOWN TYPE: ${e.type} //`;const c=document.createElement('pre');c.textContent=JSON.stringify(e,null,2);const i=document.createElement('p');return i.textContent=`Unrecognized content format for ID: ${e.id}.`,n.className=o.join(' '),n.style.animationDelay=`calc(var(--entrance-delay, 0.1s) * ${t+1})`,n.innerHTML=`<h2 class="section-title">${l}</h2>`,(()=>{const e=document.createElement('div');e.className='module-body',e.appendChild(i),e.appendChild(c),n.appendChild(e)})(),n}return n.className=o.join(' '),n.style.animationDelay=`calc(var(--entrance-delay, 0.1s) * ${t+1})`,n.innerHTML=`\n        <h2 class="section-title">${l}</h2>\n        <div class="module-body">${a}</div>\n        ${r?`\n            <div class="panel-corner corner-tl"></div><div class="panel-corner corner-tr"></div>\n            <div class="panel-corner corner-br"></div><div class="panel-corner corner-bl"></div>\n            <div class="panel-scanline ${s?"intense":""}"></div>`:""}\n    `,n}function applyStyleOverrides(e){if(e&&"object"==typeof e){const t=document.documentElement;console.log("Applying Style Overrides:",e);for(const[n,o]of Object.entries(e))"string"==typeof n&&n.startsWith('--')&&"string"==typeof o?t.style.setProperty(n,o):console.warn(`Skipping invalid style override: ${n}: ${o}`)}else e&&console.warn("Received invalid styleOverrides data:",e)}function setTextContent(e,t){try{const n=document.querySelector(e);n&&(n.textContent=t??"")}catch(e){console.error(`Error setting text for selector "${e}":`,e)}}function displayLoadError(e="Signal lost."){const t=document.querySelector('.content-grid');t&&(t.innerHTML=`<p class="error-message">// TRANSMISSION ERROR //</p><p class="error-message" style="font-size: 0.8em; color: #aaa;">Details: ${e}</p>`),console.error("Displaying load error:",e)}
